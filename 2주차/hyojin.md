# 3장. 가상 DOM

# 리액트의 가상 DOM (Virtual DOM) 개념 정리

## 1. 가상 DOM이란?

가상 DOM(Virtual DOM)은 실제 DOM의 가벼운 복사본으로, HTML 문서를 자바스크립트 객체로 모델링한 것이다. DOM(Document Object Model)은 브라우저 런타임의 문서 모델을 의미하며, 이 두 가지의 주요 차이점은:

- **실제 DOM**: 브라우저 런타임에 존재하는 노드 객체로 구성됨
- **가상 DOM**: 평범한 자바스크립트 객체로 구성된 설명적 모델임

## 2. 가상 DOM이 필요한 이유

웹 애플리케이션이 복잡해지면서 실제 DOM을 직접 관리하는 일이 어려워졌다. 그 이유는:

1. **실제 DOM 업데이트의 비효율성**:
    
    - DOM 변경 시 브라우저는 페이지 레이아웃을 다시 계산하고 화면을 다시 그리는 과정을 거침
    - 이런 과정(리플로우)는 성능에 부정적 영향을 미침
2. **직접적인 DOM 조작의 문제점**:
    
    - 복잡한 선택자를 사용한 엘리먼트 검색은 비용이 큼
    - 대규모 앱에서 일관성 유지가 어려움
    - 상태 관리가 복잡함

## 3. 실제 DOM의 문제점

### 3.1 성능 문제

- 엘리먼트 추가, 제거, 속성 변경 등으로 DOM 변경 시마다 브라우저는 레이아웃을 다시 계산하고 페이지를 다시 그려야 함
- 특히 대규모 웹페이지에서는 속도가 느려지고 리소스를 많이 사용하게 됨
- 단순히 `offsetWidth`와 같은 레이아웃 속성을 읽는 것만으로도 리플로우(reflow)가 발생하여 성능에 영향을 줄 수 있음
- CSS 선택자 최적화, 이벤트 위임, 읽기/쓰기 DOM 작업 일괄 처리, CSS 애니메이션 사용 등 이러한 문제를 완화하는 기술이 있기는 하지만 복잡하고 구현이 어려울 수 있음
- "밀리초가 수백만 달러를 만든다" 구글 웹 개발 블로그
- CPU 효율성을 우선시하면 처리 능력이나 메모리와 관계없이 다양한 기기의 사용자가 접근할 수 있는 앱 개발 가능. 참여도 올리고 전환율 높여 성능 향상


### 3.2 브라우저 간 호환성 문제

- 브라우저마다 DOM 모델링 방식이 달라 웹 애플리케이션의 일관성이 보장되지 않음
- 특정 DOM 엘리먼트와 속성을 지원하지 않는 브라우저가 있을 수 있음
- 리액트의 합성 이벤트 시스템은 이러한 차이를 추상화하여 일관된 인터페이스 제공함
- ex. SyntheticEvent는 다양한 브라우저 환경에서 이벤트를 일관적으로 처리할 수 있도록 안정적인 이벤트 시스템 제공

## 4. 가상 DOM의 작동 방식

리액트는 UI 변경 시 다음과 같은 프로세스를 따른다:

1. setState 또는 다른 메커니즘을 통해 UI 변경을 지시하면 **먼저 가상 DOM을 업데이트함**
2. 가상 DOM의 이전 버전과 새 버전을 **비교함**(diffing 알고리즘)
3. 실제 DOM에 필요한 **최소한의 변경사항만 적용함**
4. 변경사항을 **일괄 처리함**(batching)하여 최적화함

### 4.1 문서 조각 (DocumentFragment)

- DOM 노드를 저장하는 가벼운 컨테이너
- 실제 DOM에 영향을 주지 않고 여러 업데이트를 수행할 수 있는 임시 저장소
- 업데이트 작업이 완료된 후 한 번에 DOM에 추가하여 리플로우와 리페인팅을 한 번만 발생시킴
- 문서 조각의 이점
- **일괄 업데이트**:
    - 실제 DOM을 여러 번 개별적으로 업데이트하는 대신, 문서 조각 내의 모든 변경사항을 일괄적으로 처리한다.
    - 문서 조각 내에서 얼마나 많은 엘리먼트나 업데이트를 수행했든 리플로와 리페인팅은 한 번만 수행된다.
- **메모리 효율성**:
    - 문서 조각에 추가된 노드는 문서의 실제 DOM에서 제거된다.
    - 문서에서 큰 영역을 재정렬할 때 메모리 사용량을 최적화한다.
- **중복 렌더링 방지**:
    - 문서 조각은 활성화된 문서 DOM 트리에 속하지 않으므로 변경해도 실제 문서에 영향을 주지 않는다.
    - 실제 DOM에 추가될 때까지 스타일과 스크립트가 적용되지 않아 스타일 재계산과 스크립트 실행의 중복 수행을 방지한다.
- **일괄 업데이트**:
    - 문서 조각처럼 리액트의 가상 DOM도 여러 변경사항을 한꺼번에 일괄 처리한다.
    - 상태나 프롭이 변경될 때 실제 DOM을 직접 변경하는 대신, 가상 DOM에 변경사항을 먼저 적용한다.
- **효율적인 비교 알고리즘**:
    - 변경사항이 적용된 후 리액트는 현재 가상 DOM과 실제 DOM의 차이점을 확인한다.
    - 문서 조각이 직접적인 DOM 조작을 줄이듯, 이 과정도 실제 DOM에 필요한 변경만 이루어지게 한다.
- **단일 렌더링**:
    - 차이점이 식별되면 리액트는 단 한 번의 일괄 처리로 실제 DOM을 업데이트한다.
    - 이는 변경사항이 모두 반영된 문서 조각을 실제 문서에 추가하는 것과 비슷하게 동작한다.


### 4.2 리액트 엘리먼트

- 리액트에서 사용자 인터페이스는 컴포넌트 또는 HTML 엘리먼트의 가벼운 형태인 리액트 엘리먼트로 표현됨
- `React.createElement` 함수를 사용해 생성되며, JSX는 이를 더 쉽게 작성할 수 있게 해줌
- 평범한 자바스크립트 객체로, 화면에 표시되어야 할 내용을 설명함

## 5. 효율적인 업데이트 처리

### 5.1 디핑(Diffing) 알고리즘

리액트는 가상 DOM의 새 트리와 이전 트리를 비교하여 실제 DOM 업데이트에 필요한 최소한의 변경사항을 결정한다:

- 루트 노드가 다른 경우: 기존 트리 전체를 새 트리로 대체함
- 루트 노드가 동일한 경우: 노드의 속성이 변경된 경우에만 업데이트함
- 자식 노드가 다른 경우: 변경된 자식 노드만 업데이트함
- 노드가 제거/추가된 경우: 실제 DOM에서도 제거/추가함
- 노드 종류가 변경된 경우: 이전 노드 제거 후 새 노드 생성함
- key 프롭이 있는 경우: 이를 사용해 노드 교체 필요성 파악함

### 5.2 불필요한 리렌더링 문제

- 리액트는 컴포넌트 상태가 변경되면 해당 컴포넌트와 모든 자손 컴포넌트를 리렌더링함
- 이는 대규모 애플리케이션에서 성능 문제를 일으킬 수 있음
- 이런 문제는 React.memo 또는 useMemo를 사용하여 해결할 수 있음 (5장에서 자세히 다룸)

## 6. 실제 DOM vs 가상 DOM 예시

### 실제 DOM 조작 예시:

```javascript
// 실제 DOM에서 엘리먼트 선택
const h1Node = document.querySelector(".heading");

// 선택한 엘리먼트 내용 변경
if (h1Node) {
  h1Node.innerHTML = "제목이 바뀌었다!";
}
```

### 같은 작업을 리액트(가상 DOM)로 처리:

```jsx
// 상태 변경으로 UI 업데이트
function Header() {
  const [title, setTitle] = useState("반갑습니다!");
  
  const changeTitle = () => {
    setTitle("제목이 바뀌었다!");
  };
  
  return (
    <h1 className="heading" onClick={changeTitle}>
      {title}
    </h1>
  );
}
```

## 7. DOM 선택 메서드의 성능 비교

### getElementById vs querySelector

- **getElementById**:
    
    - ID 속성으로 직접 엘리먼트에 접근함
    - 해시 테이블 기반으로 O(1) 시간 복잡도에 가까움
    - ID의 고유성 때문에 재사용 컴포넌트에는 적합하지 않음
- **querySelector**:
    
    - CSS 선택자로 엘리먼트 검색함
    - 복잡한 선택자 사용 가능하지만 전체 문서 순회 필요할 수 있음
    - 최악의 경우 O(n) 시간 복잡도 (n은 DOM 내 엘리먼트 수)임

## 8. 가상 DOM의 이점

- **성능 최적화**: 실제 DOM 업데이트를 최소화하여 성능 향상시킴
- **개발 경험 개선**: 복잡한 DOM 조작 로직에서 벗어나 선언적 UI 개발 가능함
- **크로스 플랫폼 지원**: 브라우저 환경에 종속되지 않는 추상화 제공함
- **상태 관리 간소화**: 컴포넌트 기반 접근으로 상태 관리가 더 직관적임

## 정리

가상 DOM은 리액트의 핵심적인 개념으로, 실제 DOM 조작의 복잡성과 비효율성을 추상화하여 개발자가 선언적이고 효율적인 UI를 구축할 수 있게 해준다. 이는 상태 변경에 따른 UI 업데이트를 최적화하고, 개발자가 DOM 조작의 세부 사항보다 애플리케이션 로직에 집중할 수 있게 도와준다.